name: IPå»¶è¿Ÿæµ‹è¯•ï¼ˆä¸­å›½ç½‘ç»œæ¨¡æ‹Ÿï¼‰

on:
  # å®šæ—¶è§¦å‘ï¼šæ¯3å°æ—¶è¿è¡Œä¸€æ¬¡
  schedule:
    - cron: '0 */3 * * *'
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  ip-test:
    name: è¿è¡Œ IP æµ‹è¯• (${{ matrix.region }})
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        region: [CN]

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install aiohttp

      - name: é…ç½®ä¸­å›½ç½‘ç»œä»£ç†ï¼ˆå¯é€‰ï¼‰
        if: matrix.region == 'CN'
        shell: bash
        run: |
          if [ -n "${{ secrets.CN_HTTP_PROXY }}" ]; then
            echo "HTTP_PROXY=${{ secrets.CN_HTTP_PROXY }}" >> $GITHUB_ENV
            echo "HTTPS_PROXY=${{ secrets.CN_HTTPS_PROXY }}" >> $GITHUB_ENV
            echo "NO_PROXY=localhost,127.0.0.1,::1" >> $GITHUB_ENV
            echo "âœ… å·²ä¸º CN åŒºåŸŸè®¾ç½®ä»£ç†ç¯å¢ƒå˜é‡"
          else
            echo "âš ï¸ æœªæä¾› CN_HTTP_PROXY/CN_HTTPS_PROXY secretsï¼ŒæŒ‰ç›´è¿æ–¹å¼è¿è¡Œï¼ˆå¯èƒ½æ— æ³•çœŸå®æ¨¡æ‹Ÿä¸­å›½ç½‘ç»œï¼‰"
          fi

      - name: è¿è¡ŒIPæµ‹è¯•ï¼ˆ${{ matrix.region }}ï¼‰
        shell: bash
        run: |
          echo "ğŸš€ å¼€å§‹ ${GITHUB_JOB} - åŒºåŸŸ: ${{ matrix.region }}"
          mkdir -p ip_results/${{ matrix.region }}
          # è¾“å‡ºè°ƒè¯•ä¿¡æ¯ï¼šæ˜¾ç¤ºå°†ä½¿ç”¨çš„ä»£ç†
          echo "HTTP_PROXY=$HTTP_PROXY"
          echo "HTTPS_PROXY=$HTTPS_PROXY"

          # è¿è¡Œè„šæœ¬ï¼ˆä»£ç å·²æ”¯æŒ trust_env=Trueï¼Œèƒ½è¯»å–ä»£ç†ç¯å¢ƒå˜é‡ï¼‰
          python ip_tester.py --output ip_results/${{ matrix.region }}

          echo "ğŸ“ ç”Ÿæˆçš„æ–‡ä»¶:"
          ls -la ip_results/${{ matrix.region }} || true

      - name: ä¸Šä¼ ç»“æœä¸º Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ip_results_${{ matrix.region }}
          path: ip_results/${{ matrix.region }}/*.txt
          if-no-files-found: warn

  commit-results:
    name: æ±‡æ€»å¹¶æäº¤ç»“æœåˆ° main
    runs-on: ubuntu-latest
    needs: ip-test
    permissions:
      contents: write
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½æ‰€æœ‰ç»“æœ Artifact
        uses: actions/download-artifact@v4
        with:
          # ä¸‹è½½åˆ°è¯¥ç›®å½•ï¼ŒæŒ‰ artifact åç§°åˆ†å­ç›®å½•ä¿å­˜
          path: ip_results_artifacts

      - name: åˆå¹¶ç»“æœåˆ°ä»“åº“ç›®å½•
        shell: bash
        run: |
          set -e
          mkdir -p ip_results
          if [ -d ip_results_artifacts ]; then
            echo "ğŸ“¦ åˆå¹¶ Artifact åˆ° ip_results/"
            for d in ip_results_artifacts/*; do
              [ -d "$d" ] || continue
              base=$(basename "$d")            # e.g. ip_results_CN
              region=${base#ip_results_}        # -> CN
              mkdir -p ip_results/${region}
              cp -f "$d"/*.txt ip_results/${region}/ 2>/dev/null || true
            done
          else
            echo "âš ï¸ æœªæ‰¾åˆ°ä»»ä½• Artifact"
          fi

          echo "ğŸ“ åˆå¹¶åçš„ç›®å½•ç»“æ„ï¼š"
          find ip_results -maxdepth 2 -type f -name "*.txt" | sort || true

      - name: æäº¤å¹¶æ¨é€åˆ° main
        shell: bash
        run: |
          echo "ğŸ“ æäº¤ç»“æœæ–‡ä»¶åˆ°ä»“åº“..."
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # æ·»åŠ ç»“æœæ–‡ä»¶
          git add ip_results/**/*.txt || true
          git add ip_results/*.txt || true

          if git diff --cached --quiet; then
            echo "â„¹ï¸ æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          else
            git commit -m "[CI] ä¸­å›½ç½‘ç»œæ¨¡æ‹ŸIPæµ‹è¯•ç»“æœæ›´æ–° $(date +'%Y-%m-%d %H:%M:%S')"
            git push origin main
            echo "âœ… å·²æ¨é€åˆ° main åˆ†æ”¯"
          fi

      - name: å±•ç¤ºæ±‡æ€»
        shell: bash
        run: |
          echo "ğŸ“Š æ±‡æ€»:"
          find ip_results -type f -name "*.txt" | sort | xargs -I{} sh -c 'echo "--- {}"; head -n 5 "{}"; echo' || echo "æœªæ‰¾åˆ°ç»“æœæ–‡ä»¶"

