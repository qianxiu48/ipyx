name: IPå»¶è¿Ÿæµ‹è¯•

on:
  workflow_dispatch:
    inputs:
      countries:
        description: 'ç›®æ ‡å›½å®¶åˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼‰'
        required: false
        default: 'US,CN,JP,HK,TW,SG,KR,GB,DE,FR,CA,AU'
        type: string
      counts:
        description: 'æ¯ä¸ªå›½å®¶çš„ç›®æ ‡IPæ•°é‡ï¼ˆé€—å·åˆ†éš”ï¼‰'
        required: false
        default: '20,20,20,20,20,20,20,20,20,20,20,20'
        type: string
      batch_size:
        description: 'æ¯æ‰¹å¤„ç†çš„IPæ•°é‡'
        required: false
        default: '20'
        type: number
      max_ips:
        description: 'æœ€å¤§IPæ•°é‡é™åˆ¶ï¼ˆ0è¡¨ç¤ºæ— é™åˆ¶ï¼‰'
        required: false
        default: '0'
        type: number
      concurrent:
        description: 'å¹¶å‘æµ‹è¯•æ•°é‡'
        required: false
        default: '10'
        type: number
      ports:
        description: 'æµ‹è¯•ç«¯å£ï¼ˆé€—å·åˆ†éš”ï¼‰'
        required: false
        default: '443'
        type: string

jobs:
  ip-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install aiohttp

    - name: è¿è¡ŒIPæµ‹è¯•
      run: |
        # æ·»åŠ è°ƒè¯•ä¿¡æ¯
        echo "ğŸ” å½“å‰å·¥ä½œç›®å½•:"
        pwd
        echo ""
        echo "ğŸ“ è¿è¡Œå‰ç›®å½•ç»“æ„:"
        ls -la
        echo ""
        
        # è¿è¡ŒIPæµ‹è¯•ï¼ˆä¸ä½¿ç”¨çŸ©é˜µï¼Œç›´æ¥è¿è¡Œå•ä¸ªæ‰¹æ¬¡ï¼‰
        echo "ğŸš€ å¼€å§‹IPæµ‹è¯•..."
        python ip_tester.py \
          --countries "${{ github.event.inputs.countries }}" \
          --counts "${{ github.event.inputs.counts }}" \
          --batch-size ${{ github.event.inputs.batch_size }} \
          --batch-index 0 \
          --max-ips ${{ github.event.inputs.max_ips }} \
          --concurrent ${{ github.event.inputs.concurrent }} \
          --ports "${{ github.event.inputs.ports }}" \
          --output ip_results
        
        # æ£€æŸ¥æ˜¯å¦åˆ›å»ºäº†ç»“æœç›®å½•
        echo ""
        echo "ğŸ“ è¿è¡Œåç›®å½•ç»“æ„:"
        ls -la
        echo ""
        echo "ğŸ” æŸ¥æ‰¾æ‰¹æ¬¡ç»“æœç›®å½•:"
        find . -name "*batch*" -type d | sort
        echo ""
        echo "ğŸ” è¯¦ç»†æ£€æŸ¥ip_results_batch_0ç›®å½•:"
        if [ -d "ip_results_batch_0" ]; then
            echo "âœ… ip_results_batch_0ç›®å½•å­˜åœ¨"
            echo "ğŸ“‚ ç›®å½•å†…å®¹:"
            ls -la ip_results_batch_0/
            echo ""
            echo "ğŸ“„ æ–‡ä»¶åˆ—è¡¨:"
            find ip_results_batch_0 -type f -name "*.txt" | head -20
        else
            echo "âŒ ip_results_batch_0ç›®å½•ä¸å­˜åœ¨"
            echo "ğŸ” æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½çš„ç»“æœç›®å½•:"
            find . -type d -name "*result*" -o -name "*ip*" | sort
        fi

    - name: ä¸Šä¼ æµ‹è¯•ç»“æœ
      uses: actions/upload-artifact@v4
      with:
        name: ip-results
        path: ip_results_batch_0
        retention-days: 7
      if: always()  # å³ä½¿æµ‹è¯•å¤±è´¥ä¹Ÿä¸Šä¼ ç»“æœ

    - name: æ˜¾ç¤ºæµ‹è¯•ç»“æœ
      run: |
        echo "ğŸ“Š æµ‹è¯•ç»“æœæ±‡æ€»:"
        if [ -f "ip_results_batch_0/summary.txt" ]; then
          cat ip_results_batch_0/summary.txt
        else
          echo "æœªæ‰¾åˆ°æ±‡æ€»æ–‡ä»¶"
        fi