name: IPå»¶è¿Ÿæµ‹è¯•

on:
  # å®šæ—¶è§¦å‘ï¼šæ¯å¤©UTCæ—¶é—´00:00ï¼ˆåŒ—äº¬æ—¶é—´08:00ï¼‰è¿è¡Œ
  schedule:
    - cron: '0 0 * * *'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  ip-test:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install aiohttp

    - name: è¿è¡ŒIPæµ‹è¯•
      timeout-minutes: 10
      run: |
        # æ·»åŠ è°ƒè¯•ä¿¡æ¯
        echo "ğŸ” å½“å‰å·¥ä½œç›®å½•:"
        pwd
        echo ""
        echo "ğŸ“ è¿è¡Œå‰ç›®å½•ç»“æ„:"
        ls -la
        echo ""
        
        # è¿è¡ŒIPæµ‹è¯•ï¼ˆä½¿ç”¨è„šæœ¬é»˜è®¤é…ç½®ï¼‰
        echo "ğŸš€ å¼€å§‹IPæµ‹è¯•..."
        # æ·»åŠ è¶…æ—¶æ§åˆ¶å’Œé”™è¯¯å¤„ç†
        timeout 8m python ip_tester.py --output ip_results || echo "âš ï¸ IPæµ‹è¯•è¶…æ—¶æˆ–å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œåç»­æ­¥éª¤"
        
        # æ£€æŸ¥æ˜¯å¦åˆ›å»ºäº†ç»“æœç›®å½•
        echo ""
        echo "ğŸ“ è¿è¡Œåç›®å½•ç»“æ„:"
        ls -la
        echo ""
        echo "ğŸ” è¯¦ç»†æ£€æŸ¥ip_resultsç›®å½•:"
        if [ -d "ip_results" ]; then
            echo "âœ… ip_resultsç›®å½•å­˜åœ¨"
            echo "ğŸ“‚ ç›®å½•å†…å®¹:"
            ls -la ip_results/
            echo ""
            echo "ğŸ“„ æ–‡ä»¶åˆ—è¡¨:"
            find ip_results -type f -name "*.txt" | head -20
        else
            echo "âŒ ip_resultsç›®å½•ä¸å­˜åœ¨"
            echo "ğŸ” æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½çš„ç»“æœç›®å½•:"
            find . -type d -name "*result*" -o -name "*ip*" | sort
        fi

    - name: å°†ç»“æœæ–‡ä»¶å¤åˆ¶åˆ°ä»“åº“æ ¹ç›®å½•
      run: |
        echo "ğŸ“‚ å°†ç»“æœæ–‡ä»¶å¤åˆ¶åˆ°ä»“åº“æ ¹ç›®å½•..."
        if [ -d "ip_results" ]; then
          # å¤åˆ¶æ‰€æœ‰txtæ–‡ä»¶åˆ°ä»“åº“æ ¹ç›®å½•
          cp ip_results/*.txt ./
          echo "âœ… ç»“æœæ–‡ä»¶å·²å¤åˆ¶åˆ°ä»“åº“æ ¹ç›®å½•"
          echo "ğŸ“„ å½“å‰ç›®å½•ä¸‹çš„txtæ–‡ä»¶:"
          ls -la *.txt
        else
          echo "âŒ æœªæ‰¾åˆ°ç»“æœç›®å½•"
        fi

    - name: æäº¤ç»“æœæ–‡ä»¶åˆ°ä»“åº“
      run: |
        echo "ğŸ“ æäº¤ç»“æœæ–‡ä»¶åˆ°ä»“åº“..."
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„txtæ–‡ä»¶
        if ls *.txt 1> /dev/null 2>&1; then
          git add *.txt
          git commit -m "è‡ªåŠ¨æäº¤IPæµ‹è¯•ç»“æœ $(date +'%Y-%m-%d %H:%M:%S')"
          echo "âœ… ç»“æœæ–‡ä»¶å·²æäº¤åˆ°ä»“åº“"
        else
          echo "âŒ æœªæ‰¾åˆ°è¦æäº¤çš„txtæ–‡ä»¶"
          # å¦‚æœæ²¡æœ‰ç»“æœæ–‡ä»¶ï¼Œåˆ›å»ºä¸€ä¸ªç©ºçš„æäº¤æ¥é¿å…åç»­æ­¥éª¤å¤±è´¥
          git commit --allow-empty -m "IPæµ‹è¯•è¿è¡Œå®Œæˆï¼Œä½†æœªç”Ÿæˆæ–°ç»“æœæ–‡ä»¶ $(date +'%Y-%m-%d %H:%M:%S')"
        fi

    - name: æ¨é€åˆ°ä¸´æ—¶åˆ†æ”¯
      run: |
        echo "ğŸš€ æ¨é€åˆ°ä¸´æ—¶åˆ†æ”¯..."
        # åˆ›å»ºä¸´æ—¶åˆ†æ”¯å
        BRANCH_NAME="ip-results-$(date +%Y%m%d-%H%M%S)"
        
        # åˆ‡æ¢åˆ°ä¸´æ—¶åˆ†æ”¯
        git checkout -b $BRANCH_NAME
        
        # ä½¿ç”¨GitHub Tokenè¿›è¡Œæ¨é€
        git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
        git push origin $BRANCH_NAME
        echo "âœ… å·²æ¨é€åˆ°ä¸´æ—¶åˆ†æ”¯: $BRANCH_NAME"
        
        # ä¿å­˜åˆ†æ”¯åä¾›åç»­ä½¿ç”¨
        echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

    - name: åˆ›å»ºPull Request
      if: always()
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ env.BRANCH_NAME }}
        base: main
        title: "è‡ªåŠ¨æäº¤IPæµ‹è¯•ç»“æœ $(date +'%Y-%m-%d %H:%M:%S')"
        body: |
          æœ¬æ¬¡IPæµ‹è¯•ç»“æœå·²ç”Ÿæˆï¼ŒåŒ…å«ä»¥ä¸‹æ–‡ä»¶ï¼š
          - summary.txt: æµ‹è¯•æ±‡æ€»æŠ¥å‘Š
          - å„å›½å®¶IPåˆ—è¡¨æ–‡ä»¶
          
          è¯·åˆå¹¶æ­¤PRä»¥æ›´æ–°ä¸»åˆ†æ”¯ä¸­çš„æµ‹è¯•ç»“æœã€‚
        commit-message: "è‡ªåŠ¨æäº¤IPæµ‹è¯•ç»“æœ"
        delete-branch: true

    - name: æ˜¾ç¤ºæµ‹è¯•ç»“æœ
      run: |
        echo "ğŸ“Š æµ‹è¯•ç»“æœæ±‡æ€»:"
        if [ -f "summary.txt" ]; then
          cat summary.txt
        else
          echo "æœªæ‰¾åˆ°æ±‡æ€»æ–‡ä»¶"
        fi