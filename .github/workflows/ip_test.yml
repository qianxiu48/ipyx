name: IPå»¶è¿Ÿæµ‹è¯•

on:
  workflow_dispatch:
    inputs:
      countries:
        description: 'ç›®æ ‡å›½å®¶åˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼‰'
        required: false
        default: 'US'
        type: string
      counts:
        description: 'æ¯ä¸ªå›½å®¶çš„ç›®æ ‡IPæ•°é‡ï¼ˆé€—å·åˆ†éš”ï¼‰'
        required: false
        default: '3'
        type: string
      batch_size:
        description: 'æ¯æ‰¹å¤„ç†çš„IPæ•°é‡'
        required: false
        default: '20'
        type: number
      max_ips:
        description: 'æœ€å¤§IPæ•°é‡é™åˆ¶ï¼ˆ0è¡¨ç¤ºæ— é™åˆ¶ï¼‰'
        required: false
        default: '0'
        type: number
      concurrent:
        description: 'å¹¶å‘æµ‹è¯•æ•°é‡'
        required: false
        default: '10'
        type: number
      ports:
        description: 'æµ‹è¯•ç«¯å£ï¼ˆé€—å·åˆ†éš”ï¼‰'
        required: false
        default: '443'
        type: string

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      batch_count: ${{ steps.calc_batches.outputs.batch_count }}
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: è®¡ç®—æ‰¹æ¬¡æ•°é‡
      id: calc_batches
      run: |
        # æ¨¡æ‹Ÿè·å–IPæ•°é‡ï¼ˆå®é™…è¿è¡Œæ—¶ä¼šåŠ¨æ€è®¡ç®—ï¼‰
        # è¿™é‡Œä½¿ç”¨å›ºå®šå€¼æ¥æ¼”ç¤º
        TOTAL_IPS=2000
        BATCH_SIZE=${{ github.event.inputs.batch_size }}
        
        if [ $BATCH_SIZE -eq 0 ]; then
          BATCH_COUNT=1
        else
          BATCH_COUNT=$(( (TOTAL_IPS + BATCH_SIZE - 1) / BATCH_SIZE ))
        fi
        
        echo "batch_count=$BATCH_COUNT" >> $GITHUB_OUTPUT
        echo "ğŸ“Š æ€»IPæ•°é‡: $TOTAL_IPS"
        echo "ğŸ“¦ æ‰¹æ¬¡å¤§å°: $BATCH_SIZE"
        echo "ğŸ”¢ æ‰¹æ¬¡æ•°é‡: $BATCH_COUNT"

  ip-test:
    runs-on: ubuntu-latest
    needs: setup
    strategy:
      matrix:
        batch_index: ${{ fromJson(format('[0, 1, 2, 3, 4, 5, 6, 7, 8, 9]', needs.setup.outputs.batch_count)) }}
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install aiohttp

    - name: è¿è¡ŒIPæµ‹è¯•
      run: |
        python ip_tester.py \
          --countries "${{ github.event.inputs.countries }}" \
          --counts "${{ github.event.inputs.counts }}" \
          --batch-size ${{ github.event.inputs.batch_size }} \
          --batch-index ${{ matrix.batch_index }} \
          --max-ips ${{ github.event.inputs.max_ips }} \
          --concurrent ${{ github.event.inputs.concurrent }} \
          --ports "${{ github.event.inputs.ports }}" \
          --output ip_results

    - name: ä¸Šä¼ æµ‹è¯•ç»“æœ
      uses: actions/upload-artifact@v4
      with:
        name: ip-results-batch-${{ matrix.batch_index }}
        path: ip_results_batch_${{ matrix.batch_index }}/
        retention-days: 7

  merge-results:
    runs-on: ubuntu-latest
    needs: ip-test
    if: always()
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install aiohttp

    - name: ä¸‹è½½æ‰€æœ‰æ‰¹æ¬¡ç»“æœ
      uses: actions/download-artifact@v4
      with:
        path: downloaded_results
        pattern: ip-results-*
        merge-multiple: true

    - name: åˆå¹¶æ‰¹æ¬¡ç»“æœ
      run: |
        # åˆ›å»ºç»Ÿä¸€ç›®å½•ç»“æ„
        mkdir -p ip_results
        
        # å¤åˆ¶æ‰€æœ‰æ‰¹æ¬¡ç»“æœ
        for batch_dir in downloaded_results/ip-results-batch-*; do
          if [ -d "$batch_dir" ]; then
            cp -r "$batch_dir"/* ip_results/ 2>/dev/null || true
          fi
        done
        
        # è¿è¡Œåˆå¹¶è„šæœ¬
        python merge_results.py --input ip_results --output merged_results

    - name: ä¸Šä¼ åˆå¹¶ç»“æœ
      uses: actions/upload-artifact@v4
      with:
        name: merged-ip-results
        path: merged_results/
        retention-days: 30

    - name: æ˜¾ç¤ºæ±‡æ€»ä¿¡æ¯
      run: |
        echo "ğŸ“Š åˆå¹¶ç»“æœæ±‡æ€»:"
        if [ -f "merged_results/summary.txt" ]; then
          cat merged_results/summary.txt
        else
          echo "æœªæ‰¾åˆ°æ±‡æ€»æ–‡ä»¶"
        fi