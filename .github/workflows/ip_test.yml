name: IPå»¶è¿Ÿæµ‹è¯•

on:
  # å®šæ—¶è§¦å‘ï¼šæ¯3å°æ—¶è¿è¡Œä¸€æ¬¡
  schedule:
     - cron: '0 0 * * *'  # æ¯å¤©å‡Œæ™¨00:00è¿è¡Œ
     
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  ip-test:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install aiohttp

    - name: ç¯å¢ƒæµ‹è¯•
      run: |
        echo "ğŸ”§ è¿è¡Œç¯å¢ƒæµ‹è¯•..."
        python test_github_env.py
        echo "âœ… ç¯å¢ƒæµ‹è¯•å®Œæˆ"

    - name: è¿è¡ŒIPæµ‹è¯•
      timeout-minutes: 30  # è®¾ç½®30åˆ†é’Ÿè¶…æ—¶
      run: |
        # æ·»åŠ è°ƒè¯•ä¿¡æ¯
        echo "ğŸ” å½“å‰å·¥ä½œç›®å½•:"
        pwd
        echo ""
        echo "ğŸ“ è¿è¡Œå‰ç›®å½•ç»“æ„:"
        ls -la
        echo ""
        
        # æ˜¾ç¤ºç¯å¢ƒå˜é‡ï¼ˆè°ƒè¯•ç”¨ï¼‰
        echo "ğŸ”§ ç¯å¢ƒå˜é‡æ£€æŸ¥:"
        echo "GITHUB_ACTIONS: $GITHUB_ACTIONS"
        echo "RUNNER_ENVIRONMENT: $RUNNER_ENVIRONMENT"
        echo ""
        
        # è¿è¡ŒIPæµ‹è¯•ï¼ˆä½¿ç”¨GitHubä¼˜åŒ–é…ç½®ï¼‰
        echo "ğŸš€ å¼€å§‹IPæµ‹è¯•ï¼ˆGitHubä¼˜åŒ–é…ç½®ï¼‰..."
        
        # åˆ›å»ºè¾“å‡ºç›®å½•ï¼ˆç¡®ä¿å­˜åœ¨ï¼‰
        mkdir -p ip_results
        echo "âœ… å·²åˆ›å»ºip_resultsç›®å½•"
        
        # æ·»åŠ è¶…æ—¶æ§åˆ¶å’Œé”™è¯¯å¤„ç†
        set +e  # å…è®¸å‘½ä»¤å¤±è´¥è€Œä¸åœæ­¢è„šæœ¬
        
        # ä½¿ç”¨ä¼˜åŒ–çš„å‚æ•°é…ç½®ï¼Œå¢åŠ è¶…æ—¶æ—¶é—´å’Œè°ƒè¯•ä¿¡æ¯
        # æ·»åŠ timeoutå‘½ä»¤ï¼Œé˜²æ­¢è„šæœ¬æ— é™æœŸå¡ä½
        timeout 25m python ip_tester.py --output ip_results --max-ips 2000 --concurrent 10 --max-latency 3000
        exit_code=$?
        set -e  # æ¢å¤é”™è¯¯å¤„ç†
        
        if [ $exit_code -eq 0 ]; then
            echo "âœ… IPæµ‹è¯•æˆåŠŸå®Œæˆ"
        elif [ $exit_code -eq 124 ]; then
            echo "âš ï¸ IPæµ‹è¯•è¶…æ—¶ï¼ˆ25åˆ†é’Ÿï¼‰ï¼Œä½†å¯èƒ½å·²ç”Ÿæˆéƒ¨åˆ†ç»“æœ"
        else
            echo "âš ï¸ IPæµ‹è¯•å¤±è´¥ï¼ˆé€€å‡ºç : $exit_codeï¼‰ï¼Œä½†ç»§ç»­æ‰§è¡Œåç»­æ­¥éª¤"
        fi
        
        # æ£€æŸ¥æ˜¯å¦åˆ›å»ºäº†ç»“æœç›®å½•å’Œæ–‡ä»¶
        echo ""
        echo "ğŸ“ è¿è¡Œåç›®å½•ç»“æ„:"
        ls -la
        echo ""
        echo "ğŸ” è¯¦ç»†æ£€æŸ¥ip_resultsç›®å½•:"
        if [ -d "ip_results" ]; then
            echo "âœ… ip_resultsç›®å½•å­˜åœ¨"
            echo "ğŸ“‚ ç›®å½•å†…å®¹:"
            ls -la ip_results/ 2>/dev/null || echo "âš ï¸ æ— æ³•è®¿é—®ip_resultsç›®å½•"
            echo ""
            echo "ğŸ“„ æ–‡ä»¶åˆ—è¡¨:"
            find ip_results -type f -name "*.txt" 2>/dev/null | head -20 || echo "âš ï¸ æœªæ‰¾åˆ°txtæ–‡ä»¶"
        else
            echo "âŒ ip_resultsç›®å½•ä¸å­˜åœ¨"
            echo "ğŸ” æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½çš„ç»“æœç›®å½•:"
            find . -type d -name "*result*" -o -name "*ip*" 2>/dev/null | sort || echo "âš ï¸ æœªæ‰¾åˆ°ç›¸å…³ç›®å½•"
        fi
        
        # æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•ç»“æœæ–‡ä»¶
        echo ""
        echo "ğŸ” æ£€æŸ¥æ‰€æœ‰txtæ–‡ä»¶:"
        find . -name "*.txt" -type f 2>/dev/null | grep -v ".git" | head -20 || echo "âš ï¸ æœªæ‰¾åˆ°ä»»ä½•txtæ–‡ä»¶"

    - name: å°†ç»“æœæ–‡ä»¶å¤åˆ¶åˆ°ä»“åº“æ ¹ç›®å½•
      run: |
        echo "ğŸ“‚ å°†ç»“æœæ–‡ä»¶å¤åˆ¶åˆ°ä»“åº“æ ¹ç›®å½•..."
        
        # æ£€æŸ¥æ˜¯å¦æœ‰ç»“æœç›®å½•
        if [ -d "ip_results" ]; then
          # å¤åˆ¶æ‰€æœ‰txtæ–‡ä»¶åˆ°ä»“åº“æ ¹ç›®å½•
          cp ip_results/*.txt ./
          echo "âœ… ç»“æœæ–‡ä»¶å·²å¤åˆ¶åˆ°ä»“åº“æ ¹ç›®å½•"
          echo "ğŸ“„ å½“å‰ç›®å½•ä¸‹çš„txtæ–‡ä»¶:"
          ls -la *.txt 2>/dev/null || echo "âš ï¸ æ²¡æœ‰æ‰¾åˆ°txtæ–‡ä»¶"
        else
          echo "âŒ æœªæ‰¾åˆ°ç»“æœç›®å½•ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–ç»“æœæ–‡ä»¶..."
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ç›´æ¥ç”Ÿæˆçš„ç»“æœæ–‡ä»¶
          echo "ğŸ” æŸ¥æ‰¾æ‰€æœ‰txtæ–‡ä»¶:"
          find . -name "*.txt" -type f | grep -v ".git" | head -20
          
          # å¦‚æœæ‰¾åˆ°txtæ–‡ä»¶ï¼Œç›´æ¥ä½¿ç”¨å®ƒä»¬
          txt_files=$(find . -name "*.txt" -type f | grep -v ".git" | head -10)
          if [ -n "$txt_files" ]; then
            echo "âœ… æ‰¾åˆ°ä»¥ä¸‹txtæ–‡ä»¶ï¼Œç›´æ¥ä½¿ç”¨:"
            echo "$txt_files"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°ä»»ä½•ç»“æœæ–‡ä»¶ï¼Œåˆ›å»ºç©ºçš„summary.txt"
            echo "# IPæµ‹è¯•è¿è¡Œå®Œæˆï¼Œä½†æœªç”Ÿæˆç»“æœæ–‡ä»¶" > summary.txt
            echo "# ç”Ÿæˆæ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')" >> summary.txt
            echo "# å¯èƒ½åŸå› : æµ‹è¯•è¶…æ—¶ã€ç½‘ç»œé—®é¢˜æˆ–IPæºä¸å¯ç”¨" >> summary.txt
          fi
        fi

    - name: æäº¤ç»“æœæ–‡ä»¶åˆ°ä»“åº“
      run: |
        echo "ğŸ“ æäº¤ç»“æœæ–‡ä»¶åˆ°ä»“åº“..."
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„txtæ–‡ä»¶
        if ls *.txt 1> /dev/null 2>&1; then
          git add *.txt
          git commit -m "è‡ªåŠ¨æäº¤IPæµ‹è¯•ç»“æœ $(date +'%Y-%m-%d %H:%M:%S')"
          echo "âœ… ç»“æœæ–‡ä»¶å·²æäº¤åˆ°ä»“åº“"
        else
          echo "âŒ æœªæ‰¾åˆ°è¦æäº¤çš„txtæ–‡ä»¶"
          # å¦‚æœæ²¡æœ‰ç»“æœæ–‡ä»¶ï¼Œåˆ›å»ºä¸€ä¸ªç©ºçš„æäº¤æ¥é¿å…åç»­æ­¥éª¤å¤±è´¥
          git commit --allow-empty -m "IPæµ‹è¯•è¿è¡Œå®Œæˆï¼Œä½†æœªç”Ÿæˆæ–°ç»“æœæ–‡ä»¶ $(date +'%Y-%m-%d %H:%M:%S')"
        fi

    - name: ç›´æ¥æ¨é€åˆ°mainåˆ†æ”¯
      run: |
        echo "ğŸš€ ç›´æ¥æ¨é€åˆ°mainåˆ†æ”¯..."
        
        # ä½¿ç”¨GitHub Tokenè¿›è¡Œæ¨é€
        git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
        git push origin main
        echo "âœ… å·²ç›´æ¥æ¨é€åˆ°mainåˆ†æ”¯"

    - name: æ˜¾ç¤ºæµ‹è¯•ç»“æœ
      run: |
        echo "ğŸ“Š æµ‹è¯•ç»“æœæ±‡æ€»:"
        if [ -f "summary.txt" ]; then
          cat summary.txt
        else
          echo "æœªæ‰¾åˆ°æ±‡æ€»æ–‡ä»¶"
        fi
